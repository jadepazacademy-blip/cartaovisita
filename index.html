<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>üå± AR - Controle Total</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>

  <style>
    body{ margin:0; overflow:hidden; background:#000; font-family:'Poppins',sans-serif; }
    .media-container { position: fixed; inset: 0; z-index: 1; }
    video, canvas { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transform: none; }
    a-scene{ position:fixed; inset:0; z-index:2; pointer-events:none;}

    /* ESTILOS VISUAIS */
    .hint {
        position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%);
        padding: 12px 24px; border-radius: 30px;
        font-size: 13px; font-weight: 500;
        z-index: 10; text-align: center; pointer-events: none;
        width: max-content; max-width: 85%;
        background: rgba(20, 20, 20, 0.3);
        backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: white;
    }

    .glass-btn {
        position: fixed; z-index: 100;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        padding: 12px 24px; text-decoration: none;
        font-weight: 600; font-size: 14px;
        border-radius: 50px;
        transition: all 0.3s ease;
        cursor: pointer; user-select: none;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .glass-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }

    #backBtn { top: 20px; left: 20px; }

    /* Botao de informacoes */
    #infoBtn {
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 999px;
      font-size: 16px;
      line-height: 1;
    }

    #pinBtn {
        bottom: 30px; left: 50%; transform: translateX(-50%);
        width: max-content;
    }
    #pinBtn.pinned {
        background: rgba(255, 50, 50, 0.25); border-color: rgba(255, 100, 100, 0.6);
        box-shadow: 0 0 15px rgba(255, 50, 50, 0.3);
    }

    /* CONTROLE DE VELOCIDADE + PAUSE */
    #controlsContainer {
        display: none;
        position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
        z-index: 100;
        width: 90%; max-width: 350px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 15px 20px; border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);

        display: flex;
        align-items: center; gap: 15px;
        color: white; font-size: 12px; font-weight: bold;
    }

    #pauseBtn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.4);
        border-radius: 50%; width: 40px; height: 40px;
        display: flex; align-items: center; justify-content: center;
        font-size: 18px; cursor: pointer;
    }

    .slider-wrapper { flex-grow: 1; display: flex; flex-direction: column; gap: 5px; }

    input[type=range] { width: 100%; -webkit-appearance: none; appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none; height: 20px; width: 20px;
        border-radius: 50%; background: #ffffff;
        cursor: pointer; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    input[type=range]::-webkit-slider-runnable-track {
        width: 100%; height: 4px; cursor: pointer;
        background: rgba(255,255,255,0.3); border-radius: 2px;
    }

    /* MODAL DE INFORMACOES */
    .info-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 250;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .info-content {
      position: relative;
      width: 100%;
      max-width: 440px;
      max-height: 85vh;
      overflow-y: auto;
      background: rgba(30, 30, 30, 0.78);
      border-radius: 22px;
      padding: 22px 18px 18px 18px;
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
    }

    .info-content h2 {
      margin: 8px 0 10px 0;
      font-size: 18px;
    }

    .info-content h3 {
      margin: 16px 0 8px 0;
      font-size: 14px;
      opacity: 0.95;
    }

    .info-content p {
      margin: 0 0 10px 0;
      font-size: 13px;
      line-height: 1.45;
      opacity: 0.95;
    }

    .info-content ul {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
      line-height: 1.5;
    }

    .info-content li { margin: 6px 0; }

    .info-content a {
      color: #b4aaff;
      text-decoration: none;
      font-weight: 600;
      word-break: break-word;
    }

    .info-content a:active { opacity: 0.85; }

    #closeInfo {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.22);
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .info-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      margin-top: 10px;
      font-size: 12px;
      opacity: 0.95;
    }

    /* Imagem do cartao (girls.png) */
    .card-asset {
      width: min(220px, 70%);
      display: block;
      margin: 12px auto 6px auto;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
    }

    .muted {
      font-size: 12px;
      opacity: 0.85;
      margin-top: 6px;
    }
  </style>
</head>
<body>

  <a href="modelos.html" id="backBtn" class="glass-btn">‚Üê Voltar</a>

  <!-- Botao de informacoes -->
  <button id="infoBtn" class="glass-btn" aria-label="Informa√ß√µes do projeto" title="Informa√ß√µes">‚ÑπÔ∏è</button>

  <button id="pinBtn" class="glass-btn">üìç Fixar Posi√ß√£o</button>

  <div id="controlsContainer" style="display: none;">
      <button id="pauseBtn">‚è∏Ô∏è</button>

      <div class="slider-wrapper">
          <div style="display:flex; justify-content:space-between; width:100%;">
              <span>Lento</span>
              <span>R√°pido</span>
          </div>
          <input type="range" id="animSpeed" min="0.0" max="3.0" step="0.1" value="1">
      </div>
  </div>

  <div class="media-container">
    <video id="inputVideo" playsinline muted></video>
    <canvas id="outputCanvas"></canvas>
  </div>

  <div class="hint" id="hintText">
    Bem vido a nossa experi√™ncia em AR! O m√≥vel nascer√° no centro da palma, utilize o polegar e o indicador para controlar a escala!
  </div>

  <a-scene embedded vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    <a-entity id="cam" camera="near:0.01; far:100; fov: 70" position="0 0 0"></a-entity>

    <a-entity id="arObject" position="0 0 -2" visible="false">
        <a-entity id="flower"
                  gltf-model="assets/rosa.glb"
                  scale="0 0 0"
                  position="0 0 0"
                  rotation="50 0 0"
                  auto-rotate="speed: 1">
        </a-entity>
    </a-entity>

    <a-entity light="type:ambient; intensity:1.5;"></a-entity>
    <a-entity light="type:directional; intensity:2;" position="1 4 3"></a-entity>
  </a-scene>

  <!-- Modal de informacoes -->
  <div id="infoModal" class="info-modal" aria-hidden="true">
    <div class="info-content" role="dialog" aria-modal="true" aria-label="Informa√ß√µes do projeto">
      <button id="closeInfo" aria-label="Fechar">‚úï</button>

      <h2>ü¶ã Bem-vindo ao nosso cart√£o visita</h2>

      <img class="card-asset" src="assets/girls.png" alt="MobiliAR Girls" />

      <p>
        O <strong>M√≥veis Pro-AR</strong> √© uma experi√™ncia em Realidade Aumentada que permite visualizar m√≥veis em 3D no seu ambiente real,
        direto pelo navegador. Com poucos toques, voc√™ posiciona, ajusta o tamanho e explora o modelo no espa√ßo,
        facilitando a decis√£o de compra e ajudando a imaginar como o m√≥vel vai ficar antes de escolher.
      </p>

      <div class="info-chip">Dica: abra no Chrome para melhor desempenho.</div>

      <h3>üîó Links do Projeto</h3>
      <ul>
        <li>
          <a href="https://admirable-pithivier-8cf0de.netlify.app" target="_blank" rel="noopener noreferrer">
            üåê Acessar a nossa aplica√ß√£o
          </a>
        </li>
      </ul>

      <h3>üì¨ Entre em contato conosco</h3>
      <ul>
        <li>
          <a href="https://www.linkedin.com/in/jade-paz/?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app" target="_blank" rel="noopener noreferrer">
            Jade Paz
          </a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/nataliaramosdev/?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app" target="_blank" rel="noopener noreferrer">
            Nat√°lia Ramos
          </a>
        </li>
      </ul>

      <h3>ü¶ã Direitos autorais do asset (Borboleta)</h3>
      <p>
        <a href="https://sketchfab.com/3d-models/ulysses-butterfly-1155effb97564974aa0553db3d5eed57" target="_blank" rel="noopener noreferrer">
          Ulysses Butterfly (Sketchfab)
        </a>
      </p>
      <p class="muted">
        Uso apenas para fins educacionais e demonstrativos. Direitos reservados ao autor.
      </p>
    </div>
  </div>

  <!-- Componente A-Frame para rotacao automatica (sem animacao no GLB) -->
  <script>
    AFRAME.registerComponent('auto-rotate', {
      schema: { speed: { type: 'number', default: 1 } }, // rad/s (aprox)
      tick: function (time, timeDelta) {
        const speed = this.data.speed;
        this.el.object3D.rotation.y += (timeDelta / 1000) * speed;
      }
    });
  </script>

  <script>
    const videoElement = document.getElementById('inputVideo');
    const canvasElement = document.getElementById('outputCanvas');
    const canvasCtx = canvasElement.getContext('2d');
    const arObject = document.getElementById('arObject');
    const flower = document.getElementById('flower');
    const pinBtn = document.getElementById('pinBtn');
    const hintText = document.getElementById('hintText');
    const camEl = document.getElementById('cam');

    // Controles UI
    const controlsContainer = document.getElementById('controlsContainer');
    const speedSlider = document.getElementById('animSpeed');
    const pauseBtn = document.getElementById('pauseBtn');

    // Modal info
    const infoBtn = document.getElementById('infoBtn');
    const infoModal = document.getElementById('infoModal');
    const closeInfo = document.getElementById('closeInfo');

    let currentPos = new THREE.Vector3(0, 0, -2);
    let currentScale = 0;
    let isPinned = false;
    let startX = 0;
    let isPaused = false;

    // Velocidade inicial da rotacao
    flower.setAttribute('auto-rotate', 'speed', parseFloat(speedSlider.value));

    // Abrir modal
    infoBtn.addEventListener('click', () => {
      infoModal.style.display = 'flex';
      infoModal.setAttribute('aria-hidden', 'false');
    });

    // Fechar modal
    function closeModal() {
      infoModal.style.display = 'none';
      infoModal.setAttribute('aria-hidden', 'true');
    }

    closeInfo.addEventListener('click', closeModal);

    // Fecha clicando fora do conteudo
    infoModal.addEventListener('click', (e) => {
      if (e.target === infoModal) closeModal();
    });

    // Fecha com ESC (desktop)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && infoModal.style.display === 'flex') closeModal();
    });

    // Pause/Play agora controla a rotacao
    pauseBtn.addEventListener('click', () => {
        isPaused = !isPaused;
        if (isPaused) {
            pauseBtn.innerText = "‚ñ∂Ô∏è";
            flower.setAttribute('auto-rotate', 'speed', 0);
        } else {
            pauseBtn.innerText = "‚è∏Ô∏è";
            flower.setAttribute('auto-rotate', 'speed', parseFloat(speedSlider.value));
        }
    });

    // Slider controla a velocidade da rotacao
    speedSlider.addEventListener('input', (e) => {
        if (!isPaused) {
            flower.setAttribute('auto-rotate', 'speed', parseFloat(e.target.value));
        }
    });

    // Touch rotacao manual quando fixado
    document.addEventListener('touchstart', (e) => { if(isPinned) startX = e.touches[0].clientX; }, {passive:true});
    document.addEventListener('touchmove', (e) => {
        if (isPinned) {
            const deltaX = e.touches[0].clientX - startX;
            flower.object3D.rotation.y += deltaX * 0.01;
            startX = e.touches[0].clientX;
        }
    }, {passive:true});

    pinBtn.addEventListener('click', () => {
        const isVisible = arObject.getAttribute('visible');
        if (!isVisible && !isPinned) { alert("Mostre a m√£o primeiro!"); return; }

        isPinned = !isPinned;

        if (isPinned) {
            pinBtn.innerText = "üîì Soltar";
            pinBtn.classList.add('pinned');
            hintText.style.display = 'none';
            controlsContainer.style.display = 'flex';
        } else {
            pinBtn.innerText = "üìç Fixar";
            pinBtn.classList.remove('pinned');
            hintText.style.display = 'block';
            controlsContainer.style.display = 'none';
        }
    });

    // Logica AR
    function getTriangleCenter(landmarks) {
        const p0 = landmarks[0];
        const p5 = landmarks[5];
        const p17 = landmarks[17];
        return { x: (p0.x + p5.x + p17.x) / 3, y: (p0.y + p5.y + p17.y) / 3 };
    }

    function getHandAperture(landmarks) {
        const dx = landmarks[4].x - landmarks[8].x;
        const dy = landmarks[4].y - landmarks[8].y;
        let scale = Math.max(0, (Math.sqrt(dx*dx + dy*dy) - 0.02) * 15);
        return Math.min(scale, 0.8);
    }

    function updateAR(landmarks) {
        if (isPinned) return;

        arObject.setAttribute('visible', true);
        const center = getTriangleCenter(landmarks);
        const threeCamera = camEl.getObject3D('camera');
        const ndcX = (center.x * 2) - 1;
        const ndcY = -(center.y * 2) + 1;
        const vector = new THREE.Vector3(ndcX, ndcY, 0.5);
        vector.unproject(threeCamera);
        const dir = vector.sub(threeCamera.position).normalize();
        const distance = 2;
        const targetPos = threeCamera.position.clone().add(dir.multiplyScalar(distance));

        currentPos.lerp(targetPos, 0.2);
        arObject.object3D.position.copy(currentPos);

        const targetScale = getHandAperture(landmarks);
        currentScale += (targetScale - currentScale) * 0.15;
        flower.object3D.scale.set(currentScale, currentScale, currentScale);
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

    hands.onResults(results => {
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];

        if (!isPinned) {
            const p0 = landmarks[0]; const p5 = landmarks[5]; const p17 = landmarks[17];
            canvasCtx.fillStyle = "rgba(255, 255, 255, 0.3)";
            [p0, p5, p17].forEach(p => {
                canvasCtx.beginPath();
                canvasCtx.arc(p.x * canvasElement.width, p.y * canvasElement.height, 3, 0, 2 * Math.PI);
                canvasCtx.fill();
            });
            const center = getTriangleCenter(landmarks);
            canvasCtx.beginPath();
            canvasCtx.arc(center.x * canvasElement.width, center.y * canvasElement.height, 4, 0, 2 * Math.PI);
            canvasCtx.fillStyle = "rgba(255, 255, 0, 0.5)";
            canvasCtx.fill();
        }
        updateAR(landmarks);
      } else {
        if (!isPinned) { arObject.setAttribute('visible', false); currentScale = 0; }
      }
    });

    const camera = new Camera(videoElement, {
      onFrame: async () => { await hands.send({image: videoElement}); },
      width: 640, height: 480, facingMode: 'environment'
    });
    camera.start();
  </script>
</body>
</html>
